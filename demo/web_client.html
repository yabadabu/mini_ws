<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebSocket Test (Text + Binary)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    input[type="text"] { width: 360px; padding: 6px; }
    button { padding: 6px 10px; }
    pre { background: #111; color: #ddd; padding: 12px; border-radius: 8px; overflow: auto; max-height: 55vh; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h2>WebSocket Test (Text + Binary)</h2>

  <div class="row">
    <label>
      WS URL:
      <input id="url" type="text" value="ws://127.0.0.1:7450/" />
    </label>
    <button id="connect">Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
  </div>

  <div class="row">
    <label>
      Text:
      <input id="text" type="text" value="hello from browser" />
    </label>
    <button id="sendText" disabled>Send Text</button>
  </div>

  <div class="row">
    <button id="sendBinSmall" disabled>Send Binary (small)</button>
    <button id="sendBin1k" disabled>Send Binary (1KB)</button>
    <button id="clear">Clear Log</button>
  </div>

  <div class="muted">
    Notes: Browser WebSocket delivers binary as <code>Blob</code> by default. This page sets
    <code>ws.binaryType = "arraybuffer"</code> so you get <code>ArrayBuffer</code> in <code>onmessage</code>.
  </div>

  <pre id="log"></pre>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");

  function log(...args) {
    const line = args.map(a => (typeof a === "string" ? a : JSON.stringify(a))).join(" ");
    logEl.textContent += line + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function hexPreview(u8, max = 16) {
    const n = Math.min(u8.length, max);
    let s = "";
    for (let i = 0; i < n; i++) s += u8[i].toString(16).padStart(2, "0") + (i + 1 < n ? " " : "");
    if (u8.length > max) s += " â€¦";
    return s;
  }

  let ws = null;

  function setUi(connected) {
    $("connect").disabled = connected;
    $("disconnect").disabled = !connected;
    $("sendText").disabled = !connected;
    $("sendBinSmall").disabled = !connected;
    $("sendBin1k").disabled = !connected;
  }

  $("connect").addEventListener("click", () => {
    const url = $("url").value.trim();
    if (!url) return;

    log(`connecting to ${url} ...`);
    ws = new WebSocket(url);

    // IMPORTANT: get ArrayBuffer for binary messages
    ws.binaryType = "arraybuffer";

    ws.onopen = () => {
      log("open");
      setUi(true);
    };

    ws.onmessage = (ev) => {
      if (typeof ev.data === "string") {
        log(`recv text (${ev.data.length}):`, ev.data);
        return;
      }

      if (ev.data instanceof ArrayBuffer) {
        const u8 = new Uint8Array(ev.data);
        log(`recv binary (${u8.length} bytes) hex[0..]:`, hexPreview(u8));
        return;
      }

      // In case a browser still gives Blob for some reason:
      if (ev.data instanceof Blob) {
        ev.data.arrayBuffer().then((ab) => {
          const u8 = new Uint8Array(ab);
          log(`recv binary/blob (${u8.length} bytes) hex[0..]:`, hexPreview(u8));
        });
        return;
      }

      log("recv (unknown type):", String(ev.data));
    };

    ws.onerror = (e) => {
      // Browsers don't give much detail here.
      log("error (see devtools console for details)");
      console.error(e);
    };

    ws.onclose = (ev) => {
      log(`close code=${ev.code} reason="${ev.reason}" wasClean=${ev.wasClean}`);
      setUi(false);
      ws = null;
    };
  });

  $("disconnect").addEventListener("click", () => {
    if (!ws) return;
    log("closing...");
    ws.close(1000, "bye");
  });

  $("sendText").addEventListener("click", () => {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const msg = $("text").value;
    ws.send(msg);
    log(`sent text (${msg.length}):`, msg);
  });

  $("sendBinSmall").addEventListener("click", () => {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const bytes = new Uint8Array([1, 2, 3, 4, 250, 251, 252, 253, 254, 255]);
    ws.send(bytes);
    log(`sent binary (${bytes.length} bytes) hex[0..]:`, hexPreview(bytes));
  });

  $("sendBin1k").addEventListener("click", () => {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const bytes = new Uint8Array(1024);
    for (let i = 0; i < bytes.length; i++) bytes[i] = i & 255;
    ws.send(bytes);
    log(`sent binary (${bytes.length} bytes) hex[0..]:`, hexPreview(bytes));
  });

  $("clear").addEventListener("click", () => {
    logEl.textContent = "";
  });

  setUi(false);
})();
</script>
</body>
</html>
